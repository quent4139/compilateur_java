<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ListDeclClass.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Deca Compiler</a> &gt; <a href="index.source.html" class="el_package">fr.ensimag.deca.tree</a> &gt; <span class="el_source">ListDeclClass.java</span></div><h1>ListDeclClass.java</h1><pre class="source lang-java linenums">package fr.ensimag.deca.tree;

import fr.ensimag.deca.DecacCompiler;
import fr.ensimag.deca.context.ContextualError;
import fr.ensimag.deca.tools.IndentPrintStream;
import fr.ensimag.deca.tools.SymbolTable;

import org.apache.log4j.Logger;
import fr.ensimag.deca.codegen.*;
import fr.ensimag.deca.context.EnvironmentType;
import fr.ensimag.deca.context.EnvironmentExp;
import fr.ensimag.deca.tools.SymbolTable.Symbol;
import fr.ensimag.deca.context.ClassDefinition;
import fr.ensimag.deca.context.MethodDefinition;
import fr.ensimag.ima.pseudocode.Label;
import fr.ensimag.ima.pseudocode.DAddr;
import fr.ensimag.ima.pseudocode.instructions.ADDSP;
import fr.ensimag.ima.pseudocode.instructions.TSTO;
import fr.ensimag.ima.pseudocode.instructions.BOV;

/**
 *
 * @author gl37
 * @date 01/01/2022
 */
<span class="fc" id="L26">public class ListDeclClass extends TreeList&lt;AbstractDeclClass&gt; {</span>
<span class="fc" id="L27">    private static final Logger LOG = Logger.getLogger(ListDeclClass.class);</span>
    
    @Override
    public void decompile(IndentPrintStream s) {
<span class="fc bfc" id="L31" title="All 2 branches covered.">        for (AbstractDeclClass c : getList()) {</span>
<span class="fc" id="L32">            c.decompile(s);</span>
<span class="fc" id="L33">            s.println();</span>
<span class="fc" id="L34">        }</span>
<span class="fc" id="L35">    }</span>

    /**
     * Pass 1 of [SyntaxeContextuelle]
     */
    void verifyListClass(DecacCompiler compiler) throws ContextualError {
<span class="fc" id="L41">        LOG.debug(&quot;verify listClass: start&quot;);</span>
        //throw new UnsupportedOperationException(&quot;not yet implemented&quot;);
<span class="fc bfc" id="L43" title="All 2 branches covered.">        for(AbstractDeclClass declclass : getList()){</span>
<span class="fc" id="L44">            declclass.verifyClass(compiler);</span>
<span class="fc" id="L45">        }</span>
<span class="fc" id="L46">        LOG.debug(&quot;verify listClass: end&quot;);</span>
<span class="fc" id="L47">    }</span>

    /**
     * Pass 2 of [SyntaxeContextuelle]
     */
    public void verifyListClassMembers(DecacCompiler compiler) throws ContextualError {
        //throw new UnsupportedOperationException(&quot;not yet implemented&quot;);
<span class="fc" id="L54">        LOG.debug(&quot;verify ListClassMembers: start&quot;);</span>
<span class="fc bfc" id="L55" title="All 2 branches covered.">        for(AbstractDeclClass declclass : getList()){</span>
<span class="fc" id="L56">            declclass.verifyClassMembers(compiler);</span>
<span class="fc" id="L57">        }</span>
<span class="fc" id="L58">        LOG.debug(&quot;verify ListClassMembers: end&quot;);</span>
<span class="fc" id="L59">    }</span>
    
    /**
     * Pass 3 of [SyntaxeContextuelle]
     */
    public void verifyListClassBody(DecacCompiler compiler) throws ContextualError {
        //throw new UnsupportedOperationException(&quot;not yet implemented&quot;);
<span class="fc" id="L66">        LOG.debug(&quot;verify ListClassBody: start&quot;);</span>
<span class="fc bfc" id="L67" title="All 2 branches covered.">        for(AbstractDeclClass declass : getList()){</span>
<span class="fc" id="L68">            declass.verifyClassBody(compiler);</span>
<span class="fc" id="L69">        }</span>
<span class="fc" id="L70">        LOG.debug(&quot;verify ListClassBody: end&quot;);</span>
<span class="fc" id="L71">    }</span>

    /**
     * Passe 1
     * Creation of the method virtual table
     * @param compiler
     * @param listmethod
     */
    public ListMethodTable createvTable(DecacCompiler compiler){
<span class="fc" id="L80">        LOG.debug(&quot;creation of listmethodtable : begin&quot;);</span>
<span class="fc" id="L81">        ListMethodTable listTable = new ListMethodTable();</span>
        //création de la table des méthodes de Object
<span class="fc" id="L83">        EnvironmentType env_type = compiler.getEnvironmentType();</span>
<span class="fc" id="L84">        Symbol object_symb = compiler.getSymbol(&quot;Object&quot;);</span>
<span class="fc" id="L85">        ClassDefinition object_def = (ClassDefinition)env_type.get(object_symb);</span>
<span class="fc" id="L86">        EnvironmentExp env_exp_object = object_def.getMembers();</span>
<span class="fc" id="L87">        Symbol equals_symb = compiler.getSymbol(&quot;equals&quot;);</span>
<span class="fc" id="L88">        MethodDefinition equals_def = (MethodDefinition)env_exp_object.get(equals_symb);</span>
<span class="fc" id="L89">        String etiq = &quot;code.Object.equals&quot;;</span>
<span class="fc" id="L90">        Label method_label = new Label(etiq);</span>

<span class="fc" id="L92">        MethodTable object_table = new MethodTable(object_def);</span>
<span class="fc" id="L93">        object_table.setSuperAddr(null);</span>
<span class="fc" id="L94">        equals_def.setLabel(method_label);</span>
<span class="fc" id="L95">        DAddr addr_equals  = Main.rmanager.getStackMemory(); // adresse dans la pile de la méthode</span>
<span class="fc" id="L96">        equals_def.setOperand(addr_equals);</span>
<span class="fc" id="L97">        object_table.addMethod(equals_def, method_label, addr_equals);</span>
<span class="fc" id="L98">        listTable.addMethodTable(object_table);</span>
<span class="fc bfc" id="L99" title="All 2 branches covered.">        for(AbstractDeclClass declclass : getList()){</span>
<span class="fc" id="L100">            MethodTable m_tab = declclass.codeGenListMethodTable(compiler, listTable);</span>
<span class="fc" id="L101">            listTable.addMethodTable(m_tab);</span>
<span class="fc" id="L102">        }</span>
<span class="fc" id="L103">        LOG.debug(&quot;creation of listmethodtable : end&quot;);</span>
<span class="fc" id="L104">        return listTable;</span>
    }

    public static ListMethodTable list_m_table;
    /**
     * Passe 1 : virtual table coding
     * @param compiler
     */
    public void codeGenvTable(DecacCompiler compiler){
<span class="fc" id="L113">        LOG.debug(&quot;code gen table : begin&quot;);</span>
<span class="fc" id="L114">        ListMethodTable list_m_table = this.createvTable(compiler);</span>
<span class="fc" id="L115">        this.list_m_table = list_m_table; // ça pourrait ne pas marcher</span>
<span class="fc" id="L116">        int len = this.list_m_table.getLength();</span>
<span class="fc" id="L117">        compiler.addInstruction(new TSTO(len));</span>
<span class="fc" id="L118">        compiler.addInstruction(new BOV(new Label(&quot;pile_pleine&quot;)));</span>
<span class="fc" id="L119">        compiler.addInstruction(new ADDSP(len));</span>
<span class="fc" id="L120">        compiler.addComment(&quot;Début génération de la table des méthodes&quot;);</span>
<span class="fc bfc" id="L121" title="All 2 branches covered.">        for(MethodTable m: list_m_table.getlistMethodTable()){</span>
<span class="fc" id="L122">            m.codeGenTable(compiler);</span>
<span class="fc" id="L123">        }</span>
<span class="fc" id="L124">        compiler.addComment(&quot;Fin génération de la table des méthodes&quot;);</span>
<span class="fc" id="L125">        LOG.debug(&quot;codegen table : end&quot;);</span>
<span class="fc" id="L126">    }</span>

    /**
     * Passe 2 : Field initialization coding
     * @param compiler
     */
    public void codeGenInitField(DecacCompiler compiler){
<span class="fc" id="L133">        LOG.debug(&quot;code gen filed initialization : begin&quot;);</span>
<span class="fc bfc" id="L134" title="All 2 branches covered.">        for(AbstractDeclClass decl_class : this.getList()){</span>
<span class="fc" id="L135">            decl_class.codeGenInit(compiler);</span>
<span class="fc" id="L136">        }</span>
<span class="fc" id="L137">        LOG.debug(&quot;code gen filed initialization : end&quot;);</span>
<span class="fc" id="L138">    }</span>

    public void codeGenMethod(DecacCompiler compiler){
<span class="fc" id="L141">        LOG.debug(&quot;code gen list method : begin&quot;);</span>
<span class="fc bfc" id="L142" title="All 2 branches covered.">        for(AbstractDeclClass decl_class : this.getList()){</span>
<span class="fc" id="L143">            decl_class.codeGenListMethod(compiler);</span>
<span class="fc" id="L144">        }</span>
<span class="fc" id="L145">        LOG.debug(&quot;code gen list method : end&quot;);</span>
<span class="fc" id="L146">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>